{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-06-14-react-life-cycle.html","result":{"data":{"markdownRemark":{"html":"<p>React component provides several \"lifecycle methods\" that you can hook in at particular times. This <a href=\"http://projects.wojtekmaj.pl/react-lifecycle-methods-diagram\">lifecycle diagram</a> is very useful that you can use it as a cheat sheet for reference. Recently, I ran into a very complex component that I found it hard to wrap my head around . The most difficult part of that component is asynchronously fetching data in <em>componentDidUpdate</em> method in certain conditions. At the same time, <em>shouldComponentUpdate</em> method should be used properly to avoid redundant rendering. Therefore, I created a demo to simplify the props and state and retain the core logic. This demo has a button. When the button is clicked, the demo generates a random number consecutively ranging from 0 to 5 until the difference between current number and previous number is not greater than 1 or it throws an error.</p>\n<iframe src=\"https://codesandbox.io/embed/silly-shannon-1m5ne?fontsize=14\" title=\"React complicate lifecycle\" allow=\"geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media\" style=\"width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;\" sandbox=\"allow-modals allow-forms allow-popups allow-scripts allow-same-origin\"></iframe>\n<p>I made use of a few <em>console</em> APIs to illustrate what happens in every lifecycle method and when they are called. Specially <em>console.groupStart()</em> and <em>console.groupEnd()</em> help me to visualize what happened in each method and cycle.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 344px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dontry.github.io/static/8663e764a657fd4b8ecd31146177ae44/75d93/react-lifecycle-log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 189.30041152263377%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAmCAYAAADEO7urAAAACXBIWXMAAAsTAAALEwEAmpwYAAAD6ElEQVRIx51W13LiShT0/3/dfVjbJOUcRwHl0NszGNbs+oJsVZ0SAtQ6oU+3XpZlQdf1SNIMRVmi7TrIY13XH8VLR4A4TqAZJkRRKrB5niEf9JNQgHVdww9CGKaF87n5k+HyKb6T4TSOGIYeju8hTGL0w4BhHHB/rJviJRU1UnFG3c0I/RzG0UMcFciSCnXZo8galKJF2Yyb4iVRgA2qdoJIamRegXPVoyJQTaAirlGmBD1vBOz7TpXLBiDNUuimAddzMc0T5mVmEeu3yn5p2xZN0yAII+z2Rziupyb+vjvg9X1HcF9Nb56/MeWRQ5FHkqRw/QARaSTD9QI1/YosaPhgecPTKV8z9Ai0OxyxP5zwttvjqOk46QZ+vb3jnZlL0l/p9DTDgTSRWca3zHyVmQzLcWHZjvpOPlxS6mmGfd+rp8csORdCnW32sq7P6jd5rs9n9dBpmjYC8iJJZIYxM41VibKEe25v3BQJyM8oigKO4yCKog+wddMgvsxQCoLsXxhdpivLXpb1Z+Jw7WFZZPA8G1kWfyLr8hH3BH6YoQRlMvBDwHZmGNbE6YKcBAUDMGzweuVg+B9/YQKyDf+ToQSUYOhTzNkeSx1g7QpMwmGYmIWGMTcwnAWmruKkV9WKhxmO44QspnTZO4TuiapjIvVPSAMdnvmG0NmjbyspvU/VXAG2bUO1rigMLkzb48ZoOJxMHHUb7wcdr7sTHA6qH0aWOzzcFgUoN0XtcnoldsJV9FGSi5LQgnTKshxXRmzkoZSvDHku1M0pTesfYt/4vXH18pyKbRgIguBGja/KeljyVRxmXmS5LDejKEQsP/+48U9cr7eXnEZwXUudgemhMj8s+TqUslxJ3Ibkbgi6sAUr+7lwJRdmLF8IVgixYJye0qZV6nI4RhSGjt4MAl7AcgJI8DSTgMsFcHyyKT3LLquKK2cg4R7Py8jtGR/68sMeXkuuCr5BOCFFokJFe52GGUM7Yuyn7UO50kamW4YlMitDI306Iih9WrgCVVxhmZenfnJHGzWUqqDCuBxA8i0yf+l6QRgqH9bpydL5pEdfHO+gLFQemwVWZijfFKIo5Q6HCMOE2xLT9H3yMuC0hTIqaVDfWr0gcxHnpI4I4KU2YhFB8/dIi4jvNoL8G+/7uC6PPcWjoPoMI9khEBbcXMc++A9Fk6JsL6v4N5PUbn/yntumyD/HlatAnFxDUNiwsyOsdE+w7BJNjvwco+nJgFagG1sF+uUuS2ArMLC3X2EGGsxQg+4fsLN+QfeOLLlAUrEVuUnQBIIhQf/u6U2x5duXSWfyvBCabsGyXDUQTbOg87osqy+E8d/J/wa5ToZ52Iy1cAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"console\"\n        title=\"console\"\n        src=\"/dontry.github.io/static/8663e764a657fd4b8ecd31146177ae44/75d93/react-lifecycle-log.png\"\n        srcset=\"/dontry.github.io/static/8663e764a657fd4b8ecd31146177ae44/8aea6/react-lifecycle-log.png 243w,\n/dontry.github.io/static/8663e764a657fd4b8ecd31146177ae44/75d93/react-lifecycle-log.png 344w\"\n        sizes=\"(max-width: 344px) 100vw, 344px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Let's go through how <em>this.setState</em> works asynchronously. When the <em>loading</em> is set to true in <em>componentDidUpdate</em> method, it immediately goes to <em>shouldComponentUpdate</em>. If the condition is true, then it jumps to the <em>render</em> method.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 307px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/dontry.github.io/static/eeda447dd396ab1beee35b864fe4b38b/4651d/react-lifecycle-updatenumber.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 130.0411522633745%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAADt0lEQVRIx51ViW7bVhD0/39Av6BF4TZJ49RpWqNuEzltkASWUZ8SJVGkeN+XeInHdPcpcpVKrosQWJDvgRzuzuzsO6iqCnmeI8uW8IMQlmXDME1Ytg3H9eB6PoIwRNd16Pv+0ThgwCzL4NLHI2mCqTyHrKiQpjNc3dzh8voWY2mKsizRti2aphEf8g/2hQDk4CtOEuiGCdtxKTMPnu/T2hJ7umkhTTMURSne7R7KsK5r8Xde2LEOJzERLX0s/AncxIAVLTC1bxDlPoo6oyxaAuPy1xR0fbdbMgNyui6B6cGcwKYUM3iJBdkZQfEklHWBMHOx79qm4B6QLzc1YURzEXo4g0Yxc2+hBhJl6CEtIpFpQMBZmSCvMrHXUtb/ZEglF0UBLt0MNIy0S0yNOyjOBKo7w1i/pr0rTM07FFVBFKhQiQ4jVBAuXZi0XrUrShObkmssl0tBvCzTy4oBSZIhTeZQVR2KouPmRsJsporW2l8yPudwozL3Ifee7TjQDAOGZYnQqS+5nTTdEJ2QpKkQZcPbjihcMi88PxCA3MhzZUHN7WC1WqGmKMtKPDdN+2APfiYKA8ZxLBqcAaMoBvPL+/9W9FGnbAATKsegUheLhchaNPD/tNwOIDPLHLJ3uXSNRGJnbEC7rhfRb933A245JYpDGgwGiWIhLzaK9p9ij7obCraqWGfIKjOgl8HWKbu5B9/JkacN8qRBFjVIggbLeIUqX9EeCZUTv6saHQ+LLW4PalKt9KjzT1/COHkD7acB9J8HUH48g3z0GvKL3zA/PsXo6SmU49cI35zB/OUtgt//RH3xHsWvr7Cajteg5JiDmp6aBTX04VeYXJ1g9PE51L9O4I/eYTo8hnzxCpPzF5DOj+DcvkU0GiKfXaNTZTRETzk4RflusKaAxttBRb2V0piSj49w9+wJxs+f4fLwW1x9f4jRD09FDL/5GtdPvkP0xwDt5RDV8APK8/eoLj4S2Bka4pwz7AQgO4WEaWjDI2vZcQLNC6A6HswwhkHKK7ZL/rbIxzHytkNGNO2I80kY4eV129D4osHqkO2CgADVBQyyWkLNniYpAqoiiiIUdFzUlASXdx87Km+cQo0dUEZ8d1z3wWHwX47ZsZ6madB1jQZGudXU+wfBo4BBGInhwEOBY0nlrUG/wHprwBA2H5/EI/PVto2g/Iu8vB4OGUxS06QTLs9LMTibpiPg/j442839wVNvfTT2NLpABz3Iz8BM7jGfdzRUe6haj9G4E/ck7ekdsmnU783+b9ylxukXGFckAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"update_number\"\n        title=\"update_number\"\n        src=\"/dontry.github.io/static/eeda447dd396ab1beee35b864fe4b38b/4651d/react-lifecycle-updatenumber.png\"\n        srcset=\"/dontry.github.io/static/eeda447dd396ab1beee35b864fe4b38b/8aea6/react-lifecycle-updatenumber.png 243w,\n/dontry.github.io/static/eeda447dd396ab1beee35b864fe4b38b/4651d/react-lifecycle-updatenumber.png 307w\"\n        sizes=\"(max-width: 307px) 100vw, 307px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>You can notice that <strong>the Promise callback of updating number runs outside <em>didComponentUpdate</em> method</strong>. This state update then triggers another round of component rendering. Due to the nature of asynchronous update, you should always get a previous component state from the <em>this.setState</em> callback arguments instead of using <em>this.state</em>.\nOtherwise, you may not get the consistent state for update.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">prevState</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  number<span class=\"token operator\">:</span> number<span class=\"token punctuation\">,</span>\n  status<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>prevState<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">,</span> number<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  loading<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The last thing should be noted is the <a href=\"https://reactjs.org/docs/react-component.html#componentdidcatch\"><em>componentDidCatch</em></a> method and the <a href=\"https://reactjs.org/docs/error-boundaries.html\"><em>ErrorBoundary</em></a> component. I found the component didn't catch the error thrown by its child component which got me confused. I later found the <a href=\"https://github.com/facebook/react/issues/11334\">answer</a>. What it says is that error boundaries only catch errors in lifecycle methods. If the error occurs in a Promise callback, it technically doesn't happen inside the lifecycle methods. So the error boundary won't catch it. In this case, you are supposed to handle the error for the Promise callback within the scope.</p>","frontmatter":{"title":"React component lifecycle","tags":["React"],"excerpt":"React component lifecycle is a very important part of React. I created a demo to illustrate how it works with full details"},"fields":{"date":"June 13, 2019","path":"/2019-06-14-react-life-cycle.html","slug":"/blog/2019/06/14/react-life-cycle.html"}}},"pageContext":{"title":"React component lifecycle","slug":"/blog/2019/06/14/react-life-cycle.html","prev":{"html":"<p>Browser compatibility is a pain in the arse for many front-end developers. Although most modern browsers have supported the new features or syntax which mitigates the issues, the notorious IE browser is likely to be haunting around for a couple of years. Thus it is essential for us to learn some tricks to address these issues.</p>\n<p>When I decided to use Next.js to build the website, I didn't think too much about the support of IE. So I was panic when I was assigned to tackle this challenge. Luckily, <a href=\"https://nextjs.org/docs#browser-support\">Next.js supports IE11 out of box</a> which is a true life saver (another shout out for Next.js). Nevertheless, I still need to implement polyfill to handle specific problems. Browser compatibility comes down to two major parts -- JavaScript and CSS. I am going to elaborate both of them in two sections.</p>\n<h2>JavaScript</h2>\n<p>JavaScript compatibility takes syntax and new built-ins into account. The most essential tool to address JavaScript compatibility is Babel. <a href=\"https://babeljs.io/docs/en/index.html\">Babel</a> converts the new JavaScript code e.g. ES6+ into a backwards compatible version for older browsers or environments.</p>\n<h3>@babel/preset-env</h3>\n<p>Babel compiler has a wide range of plugins. The Babel community offers a preset environment <strong><a href=\"https://github.com/babel/babel-preset-env\">@babel/preset-env</a></strong> to make our life easier. The default preset includes features in babel-preset-es2015, babel-preset-es2016 and babel-preset-es2017. If you have an array of preset environments, they will be loaded from right to left. It means you should put the most backwards preset at the right end.</p>\n<p>the most basic <strong>.babelrc</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"presets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"@babel/preset-env\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Browserlist</h3>\n<p>If you want to include the polyfills and code transform for target browsers, you should then configure the <a href=\"https://github.com/browserslist/browserslist\">browserlist</a>. Browserlist is a very smart tool. It offers a range of semantic queries to identify the target browsers such as \">5%\" ( larger than 5% global usage), \"last 2 major versions\", \"ie 6-8\" etc. You can either set the browserlist in the <strong>.babelrc</strong> or create an isolated <strong>.browserlistrc</strong> file which is shared by other config files in the project.</p>\n<p><strong>.babelrc</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"presets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"env\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"targets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"browsers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\">0.25%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"not ie 11\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"not op_mini all\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>.browserlist</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"># Browsers that we support\nlast 1 version\n&gt; 1%\nIE 10</code></pre></div>\n<p><strong>package.json</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"private\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"dependencies\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"autoprefixer\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"^6.5.4\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"browserslist\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"last 1 version\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"> 1%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"IE 10\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>@babel/polyfill</h2>\n<p>Babel only transpiles JS syntax by default except for new built-ins such as Iterator, Generator, Set etc. In my case, the new ES6 method Array.from is not supported by ES5. It throws an error in an IE11 browser. So we had to add the plug-in <strong>@babel/polyfill</strong>. What we need to do is to install the <strong>@babel/polyfill</strong> as well as <strong>core-js</strong> in the <em>dependencies</em> (not <em>devDependencies</em>). The <strong>.babelrc</strong> should be configured like this. There are two options for \"useBuiltIns\".</p>\n<ul>\n<li>If \"usage\" is specified, then you don't need to include in either <strong>webpack.config.js</strong> entry array nor source.</li>\n<li>If \"entry\" is specified in <strong>.babelrc</strong> then include <strong>@babel/polyfill</strong> at the top of the entry point to your application via <em>require</em> or <em>import</em>.</li>\n<li>If use \"false\", you need to add the entry array in your <strong>webpack.config.js</strong>. In my case, the \"usage\" option doesn't include all modules for some reason. So I chose \"entry\" and import <strong>@babel/polyfill</strong> in head of the entry file.</li>\n</ul>\n<p><strong>.babelrc</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"presets\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">\"@babel/preset-env\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"useBuiltIns\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"entry\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>However, the major downside of <strong>@babel/polyfill</strong> is its huge size. It adds all available methods to the prototypes. It could be a massive waste. We can only include particular <strong>core-js</strong> module to address this issue. Another problem of <strong>@babel/polyfill</strong> is that it pollutes global scope and prototypes. If it's used in a library, it could lead to unexpected consequences to the library users.</p>\n<h2>@babel/runtime, @babel/transform-runtime</h2>\n<p>In lieu of <strong>@babel/polyfill</strong>, there is an alternative -- <strong>@babel/plugin-transform-runtime</strong>. It only generates the necessary helpers in the source which significantly reduces the size of imports. Plus, the imports don't pollute the global scope. <strong>@babel/plugin-transform-runtime</strong> is often used along with <strong>@babel/runtime</strong> which removes the duplicate helpers generated by the transform plugin.</p>\n<blockquote>\n<p>A caveat should be noted is that instance method such as \"foobar\".includes(\"foo\") will not work since that would require modification of existing built-ins. Under this circumstance, you should use <strong>babel/polyfill</strong> instead.</p>\n</blockquote>\n<h2>CSS</h2>\n<p>CSS used to be a big mess among different browsers. The notorious IE browsers are a nightmare to many developers. Besides, the inconsistent feature support made by different vendors causes a serious headache.\nThere are various approaches to tackle this problem. I would introduce the most commonly used ways in the following.</p>\n<h3>PostCSS &#x26; Autoprefixer</h3>\n<p>One of the most popular ways to mitigate the differences of CSS rules across browsers is <a href=\"https://github.com/postcss/postcss\">PostCSS</a>. More precisely, it's the <a href=\"https://github.com/postcss/autoprefixer\">Autoprefixer</a> plugin. Basically, the plugin parses CSS and add vendor prefixes to CSS rules. To set up PostCSS in Next.js, you need to install <strong>@zeit/next-css</strong>, <strong>postcss-loader</strong> and optionally <strong>postcss-preset-env</strong>. Then create a <strong>next.config.js</strong> and a <strong>postcss.config.js</strong>.</p>\n<p><strong>next.config.js</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> withPlugins <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'next-compose-plugins'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> withCss <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@zeit/next-css'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token function\">withPlugins</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">[</span>\n    withCss<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      postcssLoaderOptions<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        parser<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>postcss.config.js</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'postcss-preset-env'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>You can add '<em>grid: true</em>' to enable the grid layout in IE. Personally, I don't recommend it. Because grid layout in IE behaves very different than other popular browsers. The config also picks up <strong>.browserlistrc</strong> setting. You can specify it as '<em>browser: \"> 5%\"</em>' in the config or create an isolated <strong>.browserlist</strong> file as mentioned above.</p>\n</blockquote>\n<h3>&#x3C;!--[if IE]></h3>\n<h3>Property overrides</h3>\n<h3>@supports</h3>\n<h3>Modernizr</h3>","id":"456e674d-4959-5e7d-bcc9-ba9752e756a3","excerpt":"Browser compatibility is a pain in the arse for many front-end developers. Although most modern browsers have supported the new features or syntax which mitigates the issues, the notorious IE browser is likely to be haunting around for a couple of years. Thus it is essential for…","frontmatter":{"title":"Browser support issues in Next.js","excerpt":null,"tags":null},"fields":{"slug":"/blog/2019/06/12/nextjs-ie-support.html","date":"June 11, 2019","path":"/2019-06-12-nextjs-ie-support.html"}},"next":{"html":"<p>This document is my attempt to formally explain my mental model of React. The intention is to describe this in terms of deductive reasoning that lead us to this design.</p>\n<p>There may certainly be some premises that are debatable and the actual design of this example may have bugs and gaps. This is just the beginning of formalizing it. Feel free to send a pull request if you have a better idea of how to formalize it. The progression from simple -> complex should make sense along the way without too many library details shining through.</p>\n<p>The actual implementation of React.js is full of pragmatic solutions, incremental steps, algorithmic optimizations, legacy code, debug tooling and things you need to make it actually useful. Those things are more fleeting, can change over time if it is valuable enough and have high enough priority. The actual implementation is much more difficult to reason about.</p>\n<p>I like to have a simpler mental model that I can ground myself in.</p>\n<h2>Transformation</h2>\n<p>The core premise for React is that UIs are simply a projection of data into a different form of data. The same input gives the same output. A simple pure function.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">NameBox</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> fontWeight<span class=\"token operator\">:</span> <span class=\"token string\">'bold'</span><span class=\"token punctuation\">,</span> labelContent<span class=\"token operator\">:</span> name <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token string\">'Sebastian Markbåge'</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">{</span> fontWeight<span class=\"token operator\">:</span> <span class=\"token string\">'bold'</span><span class=\"token punctuation\">,</span> labelContent<span class=\"token operator\">:</span> <span class=\"token string\">'Sebastian Markbåge'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Abstraction</h2>\n<p>You can't fit a complex UI in a single function though. It is important that UIs can be abstracted into reusable pieces that don't leak their implementation details. Such as calling one function from another.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">FancyUserBox</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    borderStyle<span class=\"token operator\">:</span> <span class=\"token string\">'1px solid blue'</span><span class=\"token punctuation\">,</span>\n    childContent<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token string\">'Name: '</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">NameBox</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>firstName<span class=\"token operator\">==</span> <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> <span class=\"token operator\">==</span>user<span class=\"token punctuation\">.</span>lastName<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span> firstName<span class=\"token operator\">:</span> <span class=\"token string\">'Sebastian'</span><span class=\"token punctuation\">,</span> lastName<span class=\"token operator\">:</span> <span class=\"token string\">'Markbåge'</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">{</span>\n  borderStyle<span class=\"token operator\">:</span> <span class=\"token string\">'1px solid blue'</span><span class=\"token punctuation\">,</span>\n  childContent<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'Name: '</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span> fontWeight<span class=\"token operator\">:</span> <span class=\"token string\">'bold'</span><span class=\"token punctuation\">,</span> labelContent<span class=\"token operator\">:</span> <span class=\"token string\">'Sebastian Markbåge'</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Composition</h2>\n<p>To achieve truly reusable features, it is not enough to simply reuse leaves and build new containers for them. You also need to be able to build abstractions from the containers that <em>compose</em> other abstractions. The way I think about \"composition\" is that they're combining two or more different abstractions into a new one.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    borderStyle<span class=\"token operator\">:</span> <span class=\"token string\">'1px solid blue'</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token operator\">:</span> children\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">UserBox</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'Name: '</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">NameBox</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>firstName <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> user<span class=\"token punctuation\">.</span>lastName<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>State</h2>\n<p>A UI is NOT simply a replication of server / business logic state. There is actually a lot of state that is specific to an exact projection and not others. For example, if you start typing in a text field. That may or may not be replicated to other tabs or to your mobile device. Scroll position is a typical example that you almost never want to replicate across multiple projections.</p>\n<p>We tend to prefer our data model to be immutable. We thread functions through that can update state as a single atom at the top.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">FancyNameBox</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">,</span> likes<span class=\"token punctuation\">,</span> onClick</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'Name: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">NameBox</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>firstName <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> user<span class=\"token punctuation\">.</span>lastName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'Likes: '</span><span class=\"token punctuation\">,</span> <span class=\"token function\">LikeBox</span><span class=\"token punctuation\">(</span>likes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">LikeButton</span><span class=\"token punctuation\">(</span>onClick<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Implementation Details</span>\n\n<span class=\"token keyword\">var</span> likes <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">addOneMoreLike</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  likes<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">rerender</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Init</span>\n\n<span class=\"token function\">FancyNameBox</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span> firstName<span class=\"token operator\">:</span> <span class=\"token string\">'Sebastian'</span><span class=\"token punctuation\">,</span> lastName<span class=\"token operator\">:</span> <span class=\"token string\">'Markbåge'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  likes<span class=\"token punctuation\">,</span>\n  addOneMoreLike\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><em>NOTE: These examples use side-effects to update state. My actual mental model of this is that they return the next version of state during an \"update\" pass. It was simpler to explain without that but we'll want to change these examples in the future.</em></p>\n<h2>Memoization</h2>\n<p>Calling the same function over and over again is wasteful if we know that the function is pu==re. We can create a memoized version of a function that keeps track of the last argument and last result. That way we don't have to reexecute it if we keep using the same value.==</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">memoize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> cachedArg<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> cachedResult<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arg</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cachedArg <span class=\"token operator\">===</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> cachedResult<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    cachedArg <span class=\"token operator\">=</span> arg<span class=\"token punctuation\">;</span>\n    cachedResult <span class=\"token operator\">=</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> cachedResult<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> MemoizedNameBox <span class=\"token operator\">=</span> <span class=\"token function\">memoize</span><span class=\"token punctuation\">(</span>NameBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">NameAndAgeBox</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user<span class=\"token punctuation\">,</span> currentTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'Name: '</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">MemoizedNameBox</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>firstName <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> user<span class=\"token punctuation\">.</span>lastName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'Age in milliseconds: '</span><span class=\"token punctuation\">,</span>\n    currentTime <span class=\"token operator\">-</span> user<span class=\"token punctuation\">.</span>dateOfBirth\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Lists</h2>\n<p>Most UIs are some form of lists that then produce multiple different values for each item in the list. This creates a natural hierarchy.</p>\n<p>To manage the state for each item in a list we can create a Map that holds the state for a particular item.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">UserList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">users<span class=\"token punctuation\">,</span> likesPerUser<span class=\"token punctuation\">,</span> updateUserLikes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> users<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> <span class=\"token function\">FancyNameBox</span><span class=\"token punctuation\">(</span>\n    user<span class=\"token punctuation\">,</span>\n    likesPerUser<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">updateUserLikes</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> likesPerUser<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> likesPerUser <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateUserLikes</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">id<span class=\"token punctuation\">,</span> likeCount</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  likesPerUser<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> likeCount<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">rerender</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">UserList</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">,</span> likesPerUser<span class=\"token punctuation\">,</span> updateUserLikes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><em>NOTE: We now have multiple different arguments passed to FancyNameBox. That breaks our memoization because we can only remember one value at a time. More on that below.</em></p>\n<h2>Continuations</h2>\n<p>Unfortunately, since there are so many lists of lists all over the place in UIs, it becomes quite a lot of boilerplate to manage that explicitly.</p>\n<p>We can move some of this boilerplate out of our critical business logic by deferring execution of a function. For example, by using \"currying\" (<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind\"><code class=\"language-text\">bind</code></a> in JavaScript). Then we pass the state through from outside our core functions that are now free of boilerplate.</p>\n<p>This isn't reducing boilerplate but is at least moving it out of the critical business logic.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">FancyUserList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">users</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">UserList</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> users<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> box <span class=\"token operator\">=</span> <span class=\"token function\">FancyUserList</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> resolvedChildren <span class=\"token operator\">=</span> box<span class=\"token punctuation\">.</span><span class=\"token function\">children</span><span class=\"token punctuation\">(</span>likesPerUser<span class=\"token punctuation\">,</span> updateUserLikes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> resolvedBox <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>box<span class=\"token punctuation\">,</span>\n  children<span class=\"token operator\">:</span> resolvedChildren\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>State Map</h2>\n<p>We know from earlier that once we see repeated patterns we can use composition to avoid reimplementing the same pattern over and over again. We can move the logic of extracting and passing state to a low-level function that we reuse a lot.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">FancyBoxWithState</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">children<span class=\"token punctuation\">,</span>\n  stateMap<span class=\"token punctuation\">,</span>\n  updateState</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span>\n    children<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span> child<span class=\"token punctuation\">.</span><span class=\"token function\">continuation</span><span class=\"token punctuation\">(</span>\n      stateMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      updateState\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">UserList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">users</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> users<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    continuation<span class=\"token operator\">:</span> <span class=\"token function\">FancyNameBox</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    key<span class=\"token operator\">:</span> user<span class=\"token punctuation\">.</span>id\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">FancyUserList</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">users</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">FancyBoxWithState</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">UserList</span><span class=\"token punctuation\">(</span>users<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> continuation <span class=\"token operator\">=</span> <span class=\"token function\">FancyUserList</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">continuation</span><span class=\"token punctuation\">(</span>likesPerUser<span class=\"token punctuation\">,</span> updateUserLikes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Memoization Map</h2>\n<p>Once we want to memoize multiple items in a list memoization becomes much harder. You have to figure out some complex caching algorithm that balances memory usage with frequency.</p>\n<p>Luckily, UIs tend to be fairly stable in the same position. The same position in the tree gets the same value every time. This tree turns out to be a really useful strategy for memoization.</p>\n<p>We can use the same trick we used for state and pass a memoization cache through the composable function.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">memoize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arg<span class=\"token punctuation\">,</span> memoizationCache</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>memoizationCache<span class=\"token punctuation\">.</span>arg <span class=\"token operator\">===</span> arg<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> memoizationCache<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token function\">fn</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    memoizationCache<span class=\"token punctuation\">.</span>arg <span class=\"token operator\">=</span> arg<span class=\"token punctuation\">;</span>\n    memoizationCache<span class=\"token punctuation\">.</span>result <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">FancyBoxWithState</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">children<span class=\"token punctuation\">,</span>\n  stateMap<span class=\"token punctuation\">,</span>\n  updateState<span class=\"token punctuation\">,</span>\n  memoizationCache</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span>\n    children<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span> child<span class=\"token punctuation\">.</span><span class=\"token function\">continuation</span><span class=\"token punctuation\">(</span>\n      stateMap<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      updateState<span class=\"token punctuation\">,</span>\n      memoizationCache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>key<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> MemoizedFancyNameBox <span class=\"token operator\">=</span> <span class=\"token function\">memoize</span><span class=\"token punctuation\">(</span>FancyNameBox<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Algebraic Effects</h2>\n<p>It turns out that it is kind of a PITA to pass every little value you might need through several levels of abstractions. It is kind of nice to sometimes have a shortcut to pass things between two abstractions without involving the intermediates. In React we call this \"context\".</p>\n<p>Sometimes the data dependencies don't neatly follow the abstraction tree. For example, in layout algorithms you need to know something about the size of your children before you can completely fulfill their position.</p>\n<p>Now, this example is a bit \"out there\". I'll use <a href=\"http://math.andrej.com/eff/\">Algebraic Effects</a> as <a href=\"https://esdiscuss.org/topic/one-shot-delimited-continuations-with-effect-handlers\">proposed for ECMAScript</a>. If you're familiar with functional programming, they're avoiding the intermediate ceremony imposed by monads.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">ThemeBorderColorRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">FancyBox</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> color <span class=\"token operator\">=</span> raise <span class=\"token keyword\">new</span> <span class=\"token class-name\">ThemeBorderColorRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    borderWidth<span class=\"token operator\">:</span> <span class=\"token string\">'1px'</span><span class=\"token punctuation\">,</span>\n    borderColor<span class=\"token operator\">:</span> color<span class=\"token punctuation\">,</span>\n    children<span class=\"token operator\">:</span> children\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">BlueTheme</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">children</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> effect ThemeBorderColorRequest <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> continuation<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">continuation</span><span class=\"token punctuation\">(</span><span class=\"token string\">'blue'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">BlueTheme</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">FancyUserList</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">.</span>users<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","id":"085210a8-9c9f-560a-b0bd-b517dc28dea3","excerpt":"This document is my attempt to formally explain my mental model of React. The intention is to describe this in terms of deductive reasoning that lead us to this design. There may certainly be some premises that are debatable and the actual design of this example may have bugs and…","frontmatter":{"title":"React - Basic Theoretical Concepts","excerpt":null,"tags":["REACT"]},"fields":{"slug":"/blog/2017/12/08/react-basic-theoretical-concepts.html","date":"December 07, 2017","path":"/2017-12-08-react-basic-theoretical-concepts.html"}}}},"staticQueryHashes":[]}